steps:
  # 1. Build the Docker image
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}",
        "--build-arg",
        "VITE_GOOGLE_CLIENT_ID=548865347589-4aab5gaquk1oqpifan7k0jp94to7fffm.apps.googleusercontent.com",
        ".",
      ]

  # 2. Push the Docker image to Google Artifact Registry
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}",
      ]

  # 3. Deploy the new image to Google Cloud Run, using secrets from Secret Manager
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "${_SERVICE_NAME}"
      - "--image"
      - "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}"
      - "--region"
      - "${_REGION}"
      - "--platform"
      - "managed"
      - "--allow-unauthenticated"
      - "--add-cloudsql-instances"
      - "${_INSTANCE_CONNECTION_NAME}"
      - "--set-env-vars"
      - "NODE_ENV=production,DB_USER=${_DB_USER},DB_NAME=${_DB_NAME},INSTANCE_CONNECTION_NAME=${_INSTANCE_CONNECTION_NAME}"
      - "--update-secrets=JWT_SECRET=JWT_SECRET:latest,DB_PASS=DB_PASS:latest,GOOGLE_CLIENT_SECRET=GOOGLE_CLIENT_SECRET:latest"

# Define the images to be pushed to Artifact Registry
images:
  - "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}"

# Define user-configurable substitutions
substitutions:
  _PROJECT_ID: "vitacross"
  _REGION: "us-west1"
  _SERVICE_NAME: "inbound-medical-app"
  _REPOSITORY: "inbound-medical-repo"
  _INSTANCE_CONNECTION_NAME: "vitacross:us-west1:vitacross"
  _DB_USER: "app_user"
  _DB_NAME: "inbound_medical"

# Set the timeout for the build
timeout: "1200s"

options:
  logging: CLOUD_LOGGING_ONLY

